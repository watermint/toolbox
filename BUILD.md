# Building watermint toolbox

# Prerequisites

* Register your own application on Dropbox's developer site for each required application type.
* Place application keys into the file.

## Desktop development environment

Place JSON file named `toolbox.appkeys` under `resources` folder, then run or compile binaries.
`toolbox.appkeys` file format is like below:

```JSON
{
  "user_full.key": "xxxxxxxxxxxxxx",
  "user_full.secret": "xxxxxxxxxxxxxx",
  "business_info.key": "xxxxxxxxxxxxxx",
  "business_info.secret": "xxxxxxxxxxxxxx",
  "business_file.key": "xxxxxxxxxxxxxx",
  "business_file.secret": "xxxxxxxxxxxxxx",
  "business_management.key": "xxxxxxxxxxxxxx",
  "business_management.secret": "xxxxxxxxxxxxxx",
  "business_audit.key": "xxxxxxxxxxxxxx",
  "business_audit.secret": "xxxxxxxxxxxxxx"
}
```

## On CI environment (CircleCI)

Configure environment variable `TOOLBOX_APPKEYS` like below

```
{"user_full.key":"xxxxxxxxxxxxxx","user_full.secret":"xxxxxxxxxxxxxx","business_info.key":"xxxxxxxxxxxxxx","business_info.secret":"xxxxxxxxxxxxxx","business_file.key":"xxxxxxxxxxxxxx","business_file.secret":"xxxxxxxxxxxxxx","business_management.key":"xxxxxxxxxxxxxx","business_management.secret":"xxxxxxxxxxxxxx","business_audit.key":"xxxxxxxxxxxxxx","business_audit.secret":"xxxxxxxxxxxxxx"}
```

## Docker build

To build an executable, please use Docker like below.

```bash
$ docker build -t toolbox . && rm -fr /tmp/dist && docker run -v /tmp/dist:/dist:rw --rm toolbox
```

# Enhance code

## Documentation

Most documents are generated by the command `dev doc`.
And most text resources are managed under resource file `/resources/messages.json`.

For example, `README.md`, on top of this project, is also generated from the template
`/resources/README.tmpl.md`. And related text are managed with key prefix `doc.readme`.

## Message keys and convention

toolbox rely on message resource file to internationalize all texts and UI messages.
Therefore all message required to add into the resource file (`/resources/messages.json`).

To minimize code configuration, there is a naming convention & framework for typical messages.
For example, keys for recipes and their value objects are automatically mapped based on
their type package name, type name, and field names.
If there a recipe named `file/Copy.go`, and the value object `file/CopyVO`. Then those names are
mapped into `file.copy.<key>`, and `file.copy_vo.<key>`.

## Before commit

Please run command `dev preflight` to ensure all message resources and documents are available.

```bash
$ cd /path/to/PROJECT_ROOT
$ go run tbx.go dev preflight
``` 

# Test process

## End to end test

Please run below command to prepare end to end testing. Tests should pass without this step.

```bash
$ cd /path/to/PROJECT_ROOT
$ go run tbx.go dev ci auth connect
```

## Run all tests

To run all tests, please reduce concurrency to 1. Because some test are stateful for Dropbox accounts.

```bash
$ cd /path/to/PROJECT_ROOT
$ go test -p 1 ./...
```

# Release process

## Release candidate

Please run command `dev release candidate` to verify & update resources for release ready.

```bash
$ cd /path/to/PROJECT_ROOT
$ go run tbx.go dev release candidate 
```

## Publish Release

Please run `publish_release.sh` on macOs, to test binaries.
The script will generate draft release notes when all tests succeed.
